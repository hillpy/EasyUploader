!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.easyUploader=t()}(this,function(){"use strict";var e={el:"",name:"file",id:"",accept:"",file:"#file",method:"post",url:"",resType:"json",autoUpload:!0,maxFileSize:"2M",tipClass:"",allowDrag:!1,fixOrientation:!0,allowFileExt:[],compress:!0,resize:{maxWidth:800,maxHeight:800},compressQuality:.92},t=function(){};t.extend=function(e,t){for(var i in t)if(i in e){if(e[i].constructor==t[i].constructor)if(e[i].constructor===Object){var o=e[i],n=t[i];for(var a in n)o[a]=n[a];e[i]=o}else e[i]=t[i]}else e[i]=t[i];return e},t.base64ToArrayBuffer=function(e){e=e.replace(/^data\:([^\;]+)\;base64,/gim,"");for(var t=atob(e),i=t.length,o=new ArrayBuffer(i),n=new Uint8Array(o),a=0;a<i;a++)n[a]=t.charCodeAt(a);return o},t.getOrientation=function(e){var t,i,o,n,a,s,r,l,p,f,d=new DataView(e),c=d.byteLength;if(255===d.getUint8(0)&&216===d.getUint8(1))for(p=2;p<c;){if(255===d.getUint8(p)&&225===d.getUint8(p+1)){r=p;break}p++}if(r&&(i=r+4,o=r+10,"Exif"===this.getStringFromCharCode(d,i,4)&&((a=18761===(s=d.getUint16(o)))||19789===s)&&42===d.getUint16(o+2,a)&&(n=d.getUint32(o+4,a))>=8&&(l=o+n)),l)for(c=d.getUint16(l,a),f=0;f<c;f++)if(p=l+12*f+2,274===d.getUint16(p,a)){p+=8,t=d.getUint16(p,a),navigator.userAgent.indexOf("Safari")>-1&&d.setUint16(p,1,a);break}return t},t.getStringFromCharCode=function(e,t,i){var o,n="";for(o=t,i+=t;o<i;o++)n+=String.fromCharCode(e.getUint8(o));return n},t.getNonce=function(e){e||(e=16);for(var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz1234567890",i="",o=0;o<e;o++)i+=t.charAt(Math.floor(Math.random()*t.length));return i},HTMLCanvasElement.prototype.toBlob||Object.defineProperty(HTMLCanvasElement.prototype,"toBlob",{value:function(e,t,i){for(var o=atob(this.toDataURL(t,i).split(",")[1]),n=o.length,a=new Uint8Array(n),s=0;s<n;s++)a[s]=o.charCodeAt(s);e(new Blob([a],{type:t||"image/png"}))}});var i=function i(o){if(void 0===o&&(o={}),!(this instanceof i))return new i(o);this.fileObj="",this.elObj="",this.fileType="",this.fileName="",this.fileSize="",this.fileExt="",this.fileObjClickStatus=!0,this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),this.formData=new FormData,this.eval=eval,this.options=t.extend(JSON.parse(JSON.stringify(e)),o),this.init()};return i.prototype.init=function(){this.options.el?(this.elObj=document.querySelector(this.options.el),this.createInput(),this.bindElToInput(),this.options.allowDrag&&this.listenDrag(this.elObj)):(this.fileObj=document.querySelector(this.options.file),this.options.allowDrag&&this.listenDrag(this.fileObj)),this.listenFileObjClick(),this.listenFileObjChange()},i.prototype.createInput=function(){this.options.id||(this.options.id="easyuploader_"+t.getNonce());var e=document.createElement("input");e.type="file",e.name=this.options.name,e.id=this.options.id,e.accept=this.options.accept,e.setAttribute("style","display: none; !important"),document.querySelector("body").appendChild(e),this.fileObj=document.querySelector("#"+this.options.id)},i.prototype.bindElToInput=function(){var e=this;e.elObj.addEventListener("click",function(){e.fileObj.click()})},i.prototype.enableFileObjClick=function(){this.fileObjClickStatus=!0},i.prototype.disableFileObjClick=function(){this.fileObjClickStatus=!1},i.prototype.listenFileObjClick=function(){var e=this;e.fileObj.addEventListener("click",function(t){e.fileObjClickStatus||t.preventDefault()})},i.prototype.listenFileObjChange=function(){var e=this;e.fileObj.addEventListener("change",function(){e.fileType=e.fileObj.files[0].type,e.fileName=e.fileObj.files[0].name,e.fileExt=e.fileName.split(".").pop(),e.fileSize=e.fileObj.files[0].size,e.checkFile()&&(e.fileType.indexOf("image/")>=0&&e.options.compress?e.drawAndRenderCanvas():e.options.autoUpload&&e.uploadFile(e.fileObj.files[0]))})},i.prototype.listenDrag=function(e){var t=this;e.addEventListener("drop",function(e){e.preventDefault(),t.options.onDrop&&t.options.onDrop(e),t.fileObj.files=e.dataTransfer.files}),e.addEventListener("dragover",function(e){e.preventDefault(),t.options.onDragOver&&t.options.onDragOver(e)}),e.addEventListener("dragenter",function(e){e.preventDefault(),t.options.onDragEnter&&t.options.onDragEnter(e)}),e.addEventListener("dragleave",function(e){e.preventDefault(),t.options.onDragLeave&&t.options.onDragLeave(e)})},i.prototype.drawAndRenderCanvas=function(){var e=this,i=new FileReader,o=new Image,n=new ArrayBuffer,a=1,s="",r="";i.readAsDataURL(e.fileObj.files[0]),i.onload=function(e){n=t.base64ToArrayBuffer(e.target.result),a=t.getOrientation(n),o.src=e.target.result},o.onload=function(){if(e.options.compress?o.width>e.options.resize.maxWidth||o.height>e.options.resize.maxHeight?o.width>o.height?(s=e.options.resize.maxWidth,r=o.height/o.width*e.options.resize.maxWidth):(s=o.width/o.height*e.options.resize.maxHeight,r=e.options.resize.maxHeight):(s=o.width,r=o.height):(s=o.width,r=o.height,e.options.compressQuality=1),e.options.fixOrientation)switch(a){case 3:e.canvas.width=s,e.canvas.height=r,e.context.rotate(180*Math.PI/180),e.context.drawImage(o,-s,-r,s,r);break;case 6:e.canvas.width=r,e.canvas.height=s,e.context.rotate(90*Math.PI/180),e.context.drawImage(o,0,-r,s,r);break;case 8:e.canvas.width=r,e.canvas.height=s,e.context.rotate(270*Math.PI/180),e.context.drawImage(o,-s,0,s,r);break;case 1:default:e.canvas.width=s,e.canvas.height=r,e.context.drawImage(o,0,0,s,r)}else e.canvas.width=s,e.canvas.height=r,e.context.drawImage(o,0,0,s,r);e.canvas.setAttribute("style","display: none !important;"),document.querySelector("body").appendChild(e.canvas),e.options.autoUpload&&e.uploadCanvas()}},i.prototype.upload=function(){this.fileType.indexOf("image/")>=0&&this.options.compress?this.uploadCanvas():this.uploadFile(this.fileObj.files[0])},i.prototype.uploadCanvas=function(){var e=this;e.fileObj.files[0]?e.canvas.toBlob(function(t){e.uploadFile(t)},e.fileType,e.options.compressQuality):e.renderTipDom("请先选择文件")},i.prototype.uploadFile=function(e){var t=this;if(t.fileObj.files[0]){t.formData.append(t.options.name,e,t.fileName);var i=new XMLHttpRequest;i.open(t.options.method,t.options.url,!0),i.upload.addEventListener("progress",function(e){t.options.onUploadProgress&&t.options.onUploadProgress(e)}),i.upload.addEventListener("loadstart",function(e){t.options.onUploadStart&&t.options.onUploadStart(e)}),i.onreadystatechange=function(){4===i.readyState&&(i.status>=200&&i.status<300||304==i.status?t.options.onUploadComplete&&t.options.onUploadComplete(t.handleRes(i.responseText)):t.options.onUploadError&&t.options.onUploadError(i.status),t.fileObj.value="")},i.send(t.formData)}else t.renderTipDom("请先选择文件")},i.prototype.renderTipDom=function(e){var t=document.createElement("div");t.innerHTML=e,this.options.tipClass?t.className=this.options.tipClass:t.setAttribute("style","max-width: 90%;padding: 16px 20px;font-size: 14px;color: #fff;box-sizing: border-box;border-radius: 2px;filter: Alpha(opacity=80);opacity: 0.8;-moz-opacity: 0.8;user-select: none;position: fixed;top: 50%;left: 50%;z-index: 100000;transform: translate(-50%, -50%);-webkit-transform: translate(-50%, -50%);text-align: center;background: #000;word-wrap: break-word;word-break: break-all;"),document.querySelector("body").appendChild(t),setTimeout(function(){var e=t.style.opacity;if(e>0){(e=(e-.2).toFixed(1))<0&&(e=0);var i=setInterval(function(){t.style.opacity=e,t.style.filter="Alpha((opacity = "+100*e+"))",e<=0?(t.remove(),clearInterval(i)):(e=(e-.1).toFixed(1))<0&&(e=0)},10)}else t.remove()},1500)},i.prototype.checkFile=function(){var e=this.options.maxFileSize,t=0,i="";return e.indexOf("B")>0&&(e=e.replace(/B/g,""),i="B"),e.indexOf("K")>0?(t=this.eval(e.replace(/K/g,"")),e=1024*t,i="K"+i):e.indexOf("M")>0?(t=this.eval(e.replace(/M/g,"")),e=1024*t*1024,i="M"+i):e.indexOf("G")>0?(t=this.eval(e.replace(/G/g,"")),e=1024*t*1024*1024,i="G"+i):e.indexOf("T")>0?(t=this.eval(e.replace(/T/g,"")),e=1024*t*1024*1024*1024,i="T"+i):e.indexOf("P")>0?(t=this.eval(e.replace(/P/g,"")),e=1024*t*1024*1024*1024*1024,i="P"+i):(e=t=this.eval(e),i="B"),this.fileSize>e?(this.renderTipDom("文件太大，最大允许为"+t+i),this.fileObj.value="",!1):!(this.options.allowFileExt.length>0&&-1==this.options.allowFileExt.indexOf(this.fileExt))||(this.renderTipDom("文件格式不允许上传，请上传"+this.options.allowFileExt.join("，")+"格式的文件"),this.fileObj.value="",!1)},i.prototype.handleRes=function(e){var t=this.options.resType.toLowerCase();return"json"==t?JSON.parse(e):e},i});
