"use strict";var defaultOptions={el:"",name:"file",id:"",accept:"",file:"#file",method:"post",url:"",resType:"json",autoUpload:!0,maxFileSize:"2M",tipClass:"",allowDrag:!1,fixOrientation:!0,allowFileExt:[],compress:!0,resize:{maxWidth:800,maxHeight:800},compressQuality:.92},easyUploader=function e(t){if(void 0===t&&(t={}),!(this instanceof e))return new e(t);this.fileObj="",this.elObj="",this.fileType="",this.fileName="",this.fileSize="",this.fileExt="",this.fileObjClickStatus=!0,this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),this.formData=new FormData,this.eval=eval,this.options=this.extend(defaultOptions,t),this.init()};easyUploader.prototype.init=function(){this.options.el?(this.elObj=document.querySelector(this.options.el),this.createInput(),this.bindElToInput(),this.options.allowDrag&&this.listenDrag(this.elObj)):(this.fileObj=document.querySelector(this.options.file),this.options.allowDrag&&this.listenDrag(this.fileObj)),this.listenFileObjClick(),this.listenFileObjChange()},easyUploader.prototype.createInput=function(){this.options.id||(this.options.id="easyuploader_"+this.getNonce());var e=document.createElement("input");e.type="file",e.name=this.options.name,e.id=this.options.id,e.accept=this.options.accept,e.setAttribute("style","display: none; !important"),document.querySelector("body").appendChild(e),this.fileObj=document.querySelector("#"+this.options.id)},easyUploader.prototype.bindElToInput=function(){var e=this;e.elObj.addEventListener("click",function(){e.fileObj.click()})},easyUploader.prototype.enableFileObjClick=function(){this.fileObjClickStatus=!0},easyUploader.prototype.disableFileObjClick=function(){this.fileObjClickStatus=!1},easyUploader.prototype.listenFileObjClick=function(){var e=this;e.fileObj.addEventListener("click",function(t){e.fileObjClickStatus||t.preventDefault()})},easyUploader.prototype.listenFileObjChange=function(){var e=this;e.fileObj.addEventListener("change",function(){e.fileType=e.fileObj.files[0].type,e.fileName=e.fileObj.files[0].name,e.fileExt=e.fileName.split(".").pop(),e.fileSize=e.fileObj.files[0].size,e.checkFile()&&(e.fileType.indexOf("image/")>=0&&e.options.compress?e.drawAndRenderCanvas():e.options.autoUpload&&e.uploadFile(e.fileObj.files[0]))})},easyUploader.prototype.listenDrag=function(e){var t=this;e.addEventListener("drop",function(e){e.preventDefault(),t.options.onDrop&&t.options.onDrop(e),t.fileObj.files=e.dataTransfer.files}),e.addEventListener("dragover",function(e){e.preventDefault(),t.options.onDragOver&&t.options.onDragOver(e)}),e.addEventListener("dragenter",function(e){e.preventDefault(),t.options.onDragEnter&&t.options.onDragEnter(e)}),e.addEventListener("dragleave",function(e){e.preventDefault(),t.options.onDragLeave&&t.options.onDragLeave(e)})},easyUploader.prototype.renderTipDom=function(e){var t=document.createElement("div");t.innerHTML=e,this.options.tipClass?t.className=this.options.tipClass:t.setAttribute("style","max-width: 80%;padding: 16px 20px;font-size: 14px;color: #fff;box-sizing: border-box;border-radius: 2px;filter: Alpha(opacity=80);opacity: 0.8;-moz-opacity: 0.8;user-select: none;position: absolute;top: 50%;left: 50%;z-index: 100000;transform: translate(-50%, -50%);-webkit-transform: translate(-50%, -50%);text-align: center;background: #000;overflow: hidden;white-space: nowrap;text-overflow: ellipsis;"),document.querySelector("body").appendChild(t),setTimeout(function(){var e=t.style.opacity;if(e>0){(e=(e-.2).toFixed(1))<0&&(e=0);var i=setInterval(function(){t.style.opacity=e,t.style.filter="Alpha((opacity = "+100*e+"))",e<=0?(t.remove(),clearInterval(i)):(e=(e-.1).toFixed(1))<0&&(e=0)},10)}else t.remove()},1500)},easyUploader.prototype.drawAndRenderCanvas=function(){var e=this,t=new FileReader,i=new Image,o=new ArrayBuffer,a=1,n="",s="";t.readAsDataURL(e.fileObj.files[0]),t.onload=function(t){o=e.base64ToArrayBuffer(this.result),a=e.getOrientation(o),i.src=this.result},i.onload=function(){if(e.options.compress?i.width>e.options.resize.maxWidth||i.height>e.options.resize.maxHeight?i.width>i.height?(n=e.options.resize.maxWidth,s=i.height/i.width*e.options.resize.maxWidth):(n=i.width/i.height*e.options.resize.maxHeight,s=e.options.resize.maxHeight):(n=i.width,s=i.height):(n=i.width,s=i.height,e.options.compressQuality=1),e.options.fixOrientation)switch(a){case 3:e.canvas.width=n,e.canvas.height=s,e.context.rotate(180*Math.PI/180),e.context.drawImage(i,-n,-s,n,s);break;case 6:e.canvas.width=s,e.canvas.height=n,e.context.rotate(90*Math.PI/180),e.context.drawImage(i,0,-s,n,s);break;case 8:e.canvas.width=s,e.canvas.height=n,e.context.rotate(270*Math.PI/180),e.context.drawImage(i,-n,0,n,s);break;case 1:default:e.canvas.width=n,e.canvas.height=s,e.context.drawImage(i,0,0,n,s)}else e.canvas.width=n,e.canvas.height=s,e.context.drawImage(i,0,0,n,s);e.canvas.setAttribute("style","display: none !important;"),document.querySelector("body").appendChild(e.canvas),e.options.autoUpload&&e.uploadCanvas()}},easyUploader.prototype.upload=function(){this.fileType.indexOf("image/")>=0?this.uploadCanvas():this.uploadFile(this.fileObj.files[0])},easyUploader.prototype.uploadCanvas=function(){var e=this;e.fileObj.files[0]?e.canvas.toBlob(function(t){e.uploadFile(t)},e.fileType,e.options.compressQuality):this.renderTipDom("请先选择文件")},easyUploader.prototype.uploadFile=function(e){var t=this;if(t.fileObj.files[0]){t.formData.append(t.options.name,e,t.fileName);var i=new XMLHttpRequest;i.open(t.options.method,t.options.url,!0),i.upload.addEventListener("progress",function(e){t.options.onUploadProgress&&t.options.onUploadProgress(e)}),i.upload.addEventListener("loadstart",function(e){t.options.onUploadStart&&t.options.onUploadStart(e)}),i.onreadystatechange=function(){4===i.readyState&&(i.status>=200&&i.status<300||304==i.status?t.options.onUploadComplete&&t.options.onUploadComplete(t.handleRes(i.responseText)):t.options.onUploadError&&t.options.onUploadError(i.status),t.fileObj.value="")},i.send(t.formData)}else this.renderTipDom("请先选择文件")},easyUploader.prototype.base64ToArrayBuffer=function(e){e=e.replace(/^data\:([^\;]+)\;base64,/gim,"");for(var t=atob(e),i=t.length,o=new ArrayBuffer(i),a=new Uint8Array(o),n=0;n<i;n++)a[n]=t.charCodeAt(n);return o},easyUploader.prototype.getStringFromCharCode=function(e,t,i){var o,a="";for(o=t,i+=t;o<i;o++)a+=String.fromCharCode(e.getUint8(o));return a},easyUploader.prototype.getOrientation=function(e){var t,i,o,a,n,s,r,l,p,d,h=new DataView(e),f=h.byteLength;if(255===h.getUint8(0)&&216===h.getUint8(1))for(p=2;p<f;){if(255===h.getUint8(p)&&225===h.getUint8(p+1)){r=p;break}p++}if(r&&(i=r+4,o=r+10,"Exif"===this.getStringFromCharCode(h,i,4)&&((n=18761===(s=h.getUint16(o)))||19789===s)&&42===h.getUint16(o+2,n)&&(a=h.getUint32(o+4,n))>=8&&(l=o+a)),l)for(f=h.getUint16(l,n),d=0;d<f;d++)if(p=l+12*d+2,274===h.getUint16(p,n)){p+=8,t=h.getUint16(p,n),navigator.userAgent.indexOf("Safari")>-1&&h.setUint16(p,1,n);break}return t},easyUploader.prototype.checkFile=function(){var e=this.options.maxFileSize,t=0,i="";return e.indexOf("B")>0&&(e=e.replace(/B/g,""),i="B"),e.indexOf("K")>0?(t=this.eval(e.replace(/K/g,"")),e=1024*t,i="K"+i):e.indexOf("M")>0?(t=this.eval(e.replace(/M/g,"")),e=1024*t*1024,i="M"+i):e.indexOf("G")>0?(t=this.eval(e.replace(/G/g,"")),e=1024*t*1024*1024,i="G"+i):e.indexOf("T")>0?(t=this.eval(e.replace(/T/g,"")),e=1024*t*1024*1024*1024,i="T"+i):e.indexOf("P")>0?(t=this.eval(e.replace(/P/g,"")),e=1024*t*1024*1024*1024*1024,i="P"+i):(e=t=this.eval(e),i="B"),this.fileSize>e?(this.renderTipDom("文件太大，最大允许为"+t+i),this.fileObj.value="",!1):!(this.options.allowFileExt.length>0&&-1==this.options.allowFileExt.indexOf(this.fileExt))||(this.renderTipDom("文件格式不允许上传，请上传"+this.options.allowFileExt.join("，")+"格式的文件"),this.fileObj.value="",!1)},easyUploader.prototype.getNonce=function(e){e||(e=16);for(var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz1234567890",i="",o=0;o<e;o++)i+=t.charAt(Math.floor(Math.random()*t.length));return i},easyUploader.prototype.handleRes=function(e){var t=this.options.resType.toLowerCase();return"json"==t?JSON.parse(e):e},module.exports=easyUploader;
