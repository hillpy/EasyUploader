"use strict";var defaultOptions={el:"",name:"file",id:"",accept:"",file:"#file",method:"post",url:"",resType:"json",autoUpload:!0,maxFileSize:"2M",tipClass:"",allowDrag:!1,clip:!1,fixOrientation:!0,allowFileExt:[],language:"cn",compress:!0,resize:{maxWidth:800,maxHeight:800},compressQuality:.92,tipDurationTime:3},tipInfos={en:{noFile:"Please choose the file first.",fileTooLarge:"The file is too Large. The maxFileSize is {0}.",fileExtNotAllow:"The file extension is not allowed to upload. Please upload the {0} file."},cn:{noFile:"请先选择文件",fileTooLarge:"文件太大，最大允许为{0}",fileExtNotAllow:"文件扩展名不允许上传，请上传{0}格式的文件"}},defaultExport=function(){};defaultExport.extend=function(e,t){for(var i in t)if(i in e){if(e[i].constructor===t[i].constructor)if(e[i].constructor===Object){var o=e[i],a=t[i];for(var n in a)o[n]=a[n];e[i]=o}else e[i]=t[i]}else e[i]=t[i];return e},defaultExport.base64ToArrayBuffer=function(e){e=e.replace(/^data:([^;]+);base64,/gim,"");for(var t=atob(e),i=t.length,o=new ArrayBuffer(i),a=new Uint8Array(o),n=0;n<i;n++)a[n]=t.charCodeAt(n);return o},defaultExport.getOrientation=function(e){var t,i,o,a,n,s,r,l,p,f,d=new DataView(e),h=d.byteLength;if(255===d.getUint8(0)&&216===d.getUint8(1))for(p=2;p<h;){if(255===d.getUint8(p)&&225===d.getUint8(p+1)){r=p;break}p++}if(r&&(i=r+4,o=r+10,"Exif"===this.getStringFromCharCode(d,i,4)&&((n=18761===(s=d.getUint16(o)))||19789===s)&&42===d.getUint16(o+2,n)&&(a=d.getUint32(o+4,n))>=8&&(l=o+a)),l)for(h=d.getUint16(l,n),f=0;f<h;f++)if(p=l+12*f+2,274===d.getUint16(p,n)){p+=8,t=d.getUint16(p,n),navigator.userAgent.indexOf("Safari")>-1&&d.setUint16(p,1,n);break}return t},defaultExport.getStringFromCharCode=function(e,t,i){var o,a="";for(o=t,i+=t;o<i;o++)a+=String.fromCharCode(e.getUint8(o));return a},defaultExport.getNonce=function(e){e||(e=16);for(var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz1234567890",i="",o=0;o<e;o++)i+=t.charAt(Math.floor(Math.random()*t.length));return i},defaultExport.replacePlaceholders=function(e,t){e||(e=""),t||(t=[]);for(var i=0;i<t.length;i++)e=e.replace(new RegExp("\\{"+i+"\\}","g"),t[i]);return e},defaultExport.handleRes=function(e,t){return"json"===t?JSON.parse(e):e},defaultExport.evil=function(e){return new Function("return "+e)()};var name="easyuploader",version="0.0.10";HTMLCanvasElement.prototype.toBlob||Object.defineProperty(HTMLCanvasElement.prototype,"toBlob",{value:function(e,t,i){for(var o=atob(this.toDataURL(t,i).split(",")[1]),a=o.length,n=new Uint8Array(a),s=0;s<a;s++)n[s]=o.charCodeAt(s);e(new Blob([n],{type:t||"image/png"}))}});var EasyUploader=function e(t){if(void 0===t&&(t={}),!(this instanceof e))return new e(t);this.classPrefix=name.toLowerCase(),this.version=version,this.fileObj="",this.elObj="",this.fileType="",this.fileName="",this.fileSize="",this.fileExt="",this.fileObjClickStatus=!0,this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),this.formData=new FormData,this.tips={},this.options=defaultExport.extend(JSON.parse(JSON.stringify(defaultOptions)),t),this.init()};EasyUploader.prototype.init=function(){var e=JSON.parse(JSON.stringify(tipInfos));this.tips=e.hasOwnProperty(this.options.language)?e[this.options.language]:e.cn,this.options.el?(this.elObj=document.querySelector(this.options.el),this.createInput(),this.bindElToInput(),this.options.allowDrag&&this.listenDrag(this.elObj)):(this.fileObj=document.querySelector(this.options.file),this.options.allowDrag&&this.listenDrag(this.fileObj)),this.listenFileObjClick(),this.listenFileObjChange()},EasyUploader.prototype.createInput=function(){this.options.id||(this.options.id=this.classPrefix+"_"+defaultExport.getNonce());var e=document.createElement("input");e.type="file",e.name=this.options.name,e.id=this.options.id,e.accept=this.options.accept,e.setAttribute("style","display: none !important;"),this.elObj.parentNode.insertBefore(e,this.elObj.nextElementSibling),this.fileObj=document.querySelector("#"+this.options.id)},EasyUploader.prototype.bindElToInput=function(){var e=this;e.elObj.addEventListener("click",function(t){t.preventDefault(),e.fileObj.click()})},EasyUploader.prototype.enableFileObjClick=function(){this.fileObjClickStatus=!0},EasyUploader.prototype.disableFileObjClick=function(){this.fileObjClickStatus=!1},EasyUploader.prototype.listenFileObjClick=function(){var e=this;e.fileObj.addEventListener("click",function(t){e.fileObjClickStatus||t.preventDefault()})},EasyUploader.prototype.listenFileObjChange=function(){var e=this;e.fileObj.addEventListener("change",function(){e.fileIsChosen()})},EasyUploader.prototype.listenDrag=function(e){var t=this;e.addEventListener("drop",function(e){e.preventDefault(),t.options.onDrop&&t.options.onDrop(e),t.fileObj.files=e.dataTransfer.files,t.fileIsChosen()}),e.addEventListener("dragover",function(e){e.preventDefault(),t.options.onDragOver&&t.options.onDragOver(e)}),e.addEventListener("dragenter",function(e){e.preventDefault(),t.options.onDragEnter&&t.options.onDragEnter(e)}),e.addEventListener("dragleave",function(e){e.preventDefault(),t.options.onDragLeave&&t.options.onDragLeave(e)})},EasyUploader.prototype.fileIsChosen=function(){this.fileType=this.fileObj.files[0].type,this.fileName=this.fileObj.files[0].name,this.fileExt=this.fileName.split(".").pop().toLowerCase(),this.fileSize=this.fileObj.files[0].size,this.checkFile()&&(this.needCanvas()?this.drawAndRenderCanvas():this.options.autoUpload&&this.uploadFile(this.fileObj.files[0]))},EasyUploader.prototype.drawAndRenderCanvas=function(){var e=this,t=new FileReader,i=new Image,o=new ArrayBuffer,a=1,n="",s="";t.readAsDataURL(e.fileObj.files[0]),t.onload=function(e){o=defaultExport.base64ToArrayBuffer(e.target.result),a=defaultExport.getOrientation(o),i.src=e.target.result},i.onload=function(){if(e.options.compress?i.width>e.options.resize.maxWidth||i.height>e.options.resize.maxHeight?i.width>i.height?(n=e.options.resize.maxWidth,s=i.height/i.width*e.options.resize.maxWidth):(n=i.width/i.height*e.options.resize.maxHeight,s=e.options.resize.maxHeight):(n=i.width,s=i.height):(n=i.width,s=i.height,e.options.compressQuality=1),e.options.fixOrientation)switch(a){case 3:e.canvas.width=n,e.canvas.height=s,e.context.rotate(180*Math.PI/180),e.context.drawImage(i,-n,-s,n,s);break;case 6:e.canvas.width=s,e.canvas.height=n,e.context.rotate(90*Math.PI/180),e.context.drawImage(i,0,-s,n,s);break;case 8:e.canvas.width=s,e.canvas.height=n,e.context.rotate(270*Math.PI/180),e.context.drawImage(i,-n,0,n,s);break;case 1:default:e.canvas.width=n,e.canvas.height=s,e.context.drawImage(i,0,0,n,s)}else e.canvas.width=n,e.canvas.height=s,e.context.drawImage(i,0,0,n,s);e.canvas.setAttribute("style","display: none !important;"),document.querySelector("body").appendChild(e.canvas),e.options.autoUpload&&e.uploadCanvas()}},EasyUploader.prototype.upload=function(){this.fileType.indexOf("image/")>=0&&this.options.compress?this.uploadCanvas():this.uploadFile(this.fileObj.files[0])},EasyUploader.prototype.uploadCanvas=function(){var e=this;e.fileObj.files[0]?e.canvas.toBlob(function(t){e.uploadFile(t)},e.fileType,e.options.compressQuality):e.renderTipDom(this.tips.noFile)},EasyUploader.prototype.uploadFile=function(e){var t=this,i=this;if(i.fileObj.files[0]){i.formData.has(i.options.name)&&i.formData.delete(i.options.name),i.formData.append(i.options.name,e,i.fileName);var o=new XMLHttpRequest;o.open(i.options.method,i.options.url,!0),o.upload.addEventListener("progress",function(e){i.options.onUploadProgress&&i.options.onUploadProgress(e)}),o.upload.addEventListener("loadstart",function(e){i.options.onUploadStart&&i.options.onUploadStart(e)}),o.onreadystatechange=function(){4===o.readyState&&(o.status>=200&&o.status<300||304===o.status?i.options.onUploadComplete&&i.options.onUploadComplete(defaultExport.handleRes(o.responseText,t.options.resType.toLowerCase())):i.options.onUploadError&&i.options.onUploadError(o.status),i.needCanvas()&&i.canvas.remove(),i.fileObj.value="")},o.send(i.formData)}else i.renderTipDom(this.tips.noFile)},EasyUploader.prototype.renderTipDom=function(e){var t=document.getElementById(this.classPrefix+"_tipdom");t&&t.remove();var i=document.createElement("div");i.id=this.classPrefix+"_tipdom",i.innerHTML=e,this.options.tipClass?i.className=this.options.tipClass:i.setAttribute("style","max-width: 100%;padding: 16px 20px;font-size: 14px;color: #fff;box-sizing: border-box;border-radius: 2px;filter: Alpha(opacity=80);opacity: 0.8;-moz-opacity: 0.8;user-select: none;position: fixed;top: 50%;left: 50%;z-index: 100000;transform: translate(calc(-50% + 0.5px), calc(-50% + 0.5px));-webkit-transform: translate(calc(-50% + 0.5px), calc(-50% + 0.5px));text-align: center;background: #000;word-wrap: break-word;word-break: break-all;"),document.querySelector("body").appendChild(i);var o=defaultOptions.tipDurationTime;"number"==typeof this.options.tipDurationTime&&this.options.tipDurationTime>0&&(o=this.options.tipDurationTime),setTimeout(function(){var e=i.style.opacity;if(e>0){(e=(e-.2).toFixed(1))<0&&(e=0);var t=setInterval(function(){i.style.opacity=e,i.style.filter="Alpha((opacity = "+100*e+"))",e<=0?(i.remove(),clearInterval(t)):(e=(e-.1).toFixed(1))<0&&(e=0)},10)}else i.remove()},1e3*o)},EasyUploader.prototype.checkFile=function(){var e=this.options.maxFileSize,t=0,i="";return e.indexOf("B")>0&&(e=e.replace(/B/g,""),i="B"),e.indexOf("K")>0?(t=defaultExport.evil(e.replace(/K/g,"")),e=1024*t,i="K"+i):e.indexOf("M")>0?(t=defaultExport.evil(e.replace(/M/g,"")),e=1024*t*1024,i="M"+i):e.indexOf("G")>0?(t=defaultExport.evil(e.replace(/G/g,"")),e=1024*t*1024*1024,i="G"+i):e.indexOf("T")>0?(t=defaultExport.evil(e.replace(/T/g,"")),e=1024*t*1024*1024*1024,i="T"+i):e.indexOf("P")>0?(t=defaultExport.evil(e.replace(/P/g,"")),e=1024*t*1024*1024*1024*1024,i="P"+i):(e=t=defaultExport.evil(e),i="B"),this.fileSize>e?(this.renderTipDom(defaultExport.replacePlaceholders(this.tips.fileTooLarge,[t+i])),this.fileObj.value="",!1):!(this.options.allowFileExt.length>0&&-1===this.options.allowFileExt.indexOf(this.fileExt))||(this.renderTipDom(defaultExport.replacePlaceholders(this.tips.fileExtNotAllow,[this.options.allowFileExt.join("，")])),this.fileObj.value="",!1)},EasyUploader.prototype.needCanvas=function(){return!!(this.fileType.indexOf("image/")>=0&&(this.options.compress||this.options.clip))},module.exports=EasyUploader;
